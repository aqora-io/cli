mod convert;
mod infer;
mod upload;
mod utils;
mod version;

use convert::{convert, Convert};
use get_dataset_by_slug::GetDatasetBySlugDatasetBySlug;
use infer::{infer, Infer};
use upload::{upload, Upload};
use version::{version, Version};

use clap::{Args, Subcommand};
use serde::Serialize;

use super::GlobalArgs;
use crate::{
    error::{self, Result},
    graphql_client::{custom_scalars::*, GraphQLClient},
};
use graphql_client::GraphQLQuery;

#[derive(Args, Debug, Serialize, Clone)]
pub struct DatasetGlobalArgs {
    /// Dataset you want to upload to, must respect "{owner}/{dataset}" form.
    slug: String,
}

#[derive(Subcommand, Debug, Serialize)]
pub enum Dataset {
    #[command(hide = true)]
    Infer(Infer),
    #[command(hide = true)]
    Convert(Convert),
    Upload {
        #[command(flatten)]
        dataset_global: DatasetGlobalArgs,
        #[command(flatten)]
        args: Upload,
    },
    Version {
        #[command(flatten)]
        dataset_global: DatasetGlobalArgs,
        #[command(subcommand)]
        args: Version,
    },
}

#[derive(GraphQLQuery)]
#[graphql(
    query_path = "src/graphql/get_dataset_by_slug.graphql",
    schema_path = "schema.graphql",
    response_derives = "Debug"
)]
pub struct GetDatasetBySlug;

#[derive(GraphQLQuery)]
#[graphql(
    query_path = "src/graphql/create_dataset.graphql",
    schema_path = "schema.graphql",
    response_derives = "Debug"
)]
pub struct CreateDataset;

pub async fn get_dataset_by_slug(
    global: GlobalArgs,
    slug: String,
) -> Result<GetDatasetBySlugDatasetBySlug> {
    let client = global.graphql_client().await?;

    // Find dataset the user wants to upload
    let Some((owner, local_slug)) = slug.split_once('/') else {
        return Err(error::user(
            "Malformed slug",
            "Expected a slug like: {owner}/{dataset}",
        ));
    };

    let dataset = client
        .send::<GetDatasetBySlug>(get_dataset_by_slug::Variables {
            owner: owner.to_string(),
            local_slug: local_slug.to_string(),
        })
        .await?
        .dataset_by_slug;

    let Some(dataset) = dataset else {
        // TODO : ASK
        let dataset_visibility = global
            .confirm()
            .with_prompt("Would you like to create this dataset as private or public?")
            .default(true)
            .interact()?;

        let name = "ss";

        let new_dataset = client
            .send::<CreateDataset>(create_dataset::Variables {
                owner: Some(owner.to_string()),
                input: create_dataset::CreateDatasetInput {
                    name: name.to_string(),
                    local_slug: local_slug.to_string(),
                    private: dataset_visibility,
                    tags: vec![],
                },
            })
            .await?
            .create_dataset;

        return Ok(GetDatasetBySlugDatasetBySlug {
            id: new_dataset.id,
            viewer_can_create_version: new_dataset.viewer_can_create_version,
        });
    };

    Ok(dataset)
}

pub async fn dataset(args: Dataset, global: GlobalArgs) -> Result<()> {
    match args {
        Dataset::Infer(args) => infer(args, global).await,
        Dataset::Convert(args) => convert(args, global).await,
        Dataset::Upload {
            dataset_global,
            args,
        } => upload(args, dataset_global, global).await,
        Dataset::Version {
            dataset_global,
            args,
        } => version(args, dataset_global, global).await,
    }
}
